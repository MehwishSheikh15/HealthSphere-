rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the existing owner of the resource.
     * Ensures that the document exists before allowing the operation.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId));
    }

    /**
     * @description Enforces that the incoming document ID matches the authenticated user's ID during creation.
     */
    function isValidUserId() {
      return request.resource.data.id == request.auth.uid;
    }

    /**
     * @description Checks if the doctor is verified.
     * @dev This function assumes that the doctor's verification status is denormalized on the document.
     */
    function isDoctorVerified(doctorId) {
      return get(/databases/$(database)/documents/doctors/$(doctorId)).data.isVerified == true;
    }


    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) User with matching UID can create their profile.
     * @allow (get, update, delete) User can access and modify their own profile.
     * @deny (create) User cannot create a profile with a mismatched UID.
     * @deny (get, update, delete) User cannot access or modify another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for doctor profiles.
     * @path /doctors/{doctorId}
     * @allow (get, list) Anyone can read doctor profiles.
     * @allow (create) Only authenticated doctors can create their profiles.
     * @allow (update, delete) Only the authenticated doctor can update/delete their own profile.
     * @deny (create, update, delete) Unauthorized users cannot create, update, or delete doctor profiles.
     * @principle Public read access with owner-only writes.
     */
    match /doctors/{doctorId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == doctorId;
      allow update: if isSignedIn() && request.auth.uid == doctorId;
      allow delete: if isSignedIn() && request.auth.uid == doctorId;
    }

    /**
     * @description Rules for appointments.
     * @path /appointments/{appointmentId}
     * @allow (get) Patient or doctor involved in the appointment can read the appointment.
     * @allow (create) Only authenticated users can create appointments.
     * @allow (update, delete) Only the patient or doctor involved can update or delete the appointment, and if the doctor is verified.
     * @deny (get) Unauthorized users cannot read appointment details.
     * @deny (create, update, delete) Unauthorized users cannot create, update, or delete appointments.
     * @principle Shared access between patient and doctor.
     */
    match /appointments/{appointmentId} {
      allow get: if isSignedIn() && (get(/databases/$(database)/documents/appointments/$(appointmentId)).data.patientId == request.auth.uid || get(/databases/$(database)/documents/appointments/$(appointmentId)).data.doctorId == request.auth.uid);
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (get(/databases/$(database)/documents/appointments/$(appointmentId)).data.patientId == request.auth.uid || get(/databases/$(database)/documents/appointments/$(appointmentId)).data.doctorId == request.auth.uid);
      allow delete: if isSignedIn() && (get(/databases/$(database)/documents/appointments/$(appointmentId)).data.patientId == request.auth.uid || get(/databases/$(database)/documents/appointments/$(appointmentId)).data.doctorId == request.auth.uid);
    }

    /**
     * @description Rules for transactions.
     * @path /transactions/{transactionId}
     * @allow (get) Patient, doctor or admin involved in the transaction can read the transaction.
     * @allow (create) Only authenticated users can create transactions.
     * @allow (update, delete) No one can update or delete transactions.
     * @deny (get) Unauthorized users cannot read transaction details.
     * @deny (create, update, delete) Unauthorized users cannot create, update, or delete transactions.
     * @principle Shared access between patient, doctor and admin.
     */
    match /transactions/{transactionId} {
      allow get: if isSignedIn() && (get(/databases/$(database)/documents/transactions/$(transactionId)).data.patientId == request.auth.uid || get(/databases/$(database)/documents/transactions/$(transactionId)).data.doctorId == request.auth.uid);
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for doctor wallets.
     * @path /wallets/{walletId}
     * @allow (get, update) Only the doctor can read and update their own wallet.
     * @allow (create) Only the authenticated doctor can create the wallet.
     * @allow (delete) Only the authenticated doctor can delete the wallet.
     * @deny (get, update) Unauthorized users cannot read or update wallet details.
     * @principle Owner-only access for wallets.
     */
    match /wallets/{walletId} {
      allow get: if isSignedIn() && get(/databases/$(database)/documents/wallets/$(walletId)).data.doctorId == request.auth.uid;
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.doctorId;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/wallets/$(walletId)).data.doctorId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/wallets/$(walletId)).data.doctorId == request.auth.uid;
    }

    /**
     * @description Rules for reminders.
     * @path /reminders/{reminderId}
     * @allow (get, list) Only the user can read their own reminders.
     * @allow (create, update, delete) Only the user can create, update, and delete their own reminders.
     * @deny (get, list, create, update, delete) Unauthorized users cannot access or modify reminders.
     * @principle Owner-only access for reminders.
     */
    match /reminders/{reminderId} {
      allow get: if isSignedIn() && get(/databases/$(database)/documents/reminders/$(reminderId)).data.userId == request.auth.uid;
      allow list: if isSignedIn() && get(/databases/$(database)/documents/reminders/$(reminderId)).data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/reminders/$(reminderId)).data.userId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/reminders/$(reminderId)).data.userId == request.auth.uid;
    }

    /**
     * @description Rules for subscriptions.
     * @path /subscriptions/{subscriptionId}
     * @allow (get, list) Only the user can read their own subscription.
     * @allow (create, update, delete) Only the user can create, update, and delete their own subscription.
     * @deny (get, list, create, update, delete) Unauthorized users cannot access or modify subscriptions.
     * @principle Owner-only access for subscriptions.
     */
    match /subscriptions/{subscriptionId} {
      allow get: if isSignedIn() && get(/databases/$(database)/documents/subscriptions/$(subscriptionId)).data.userId == request.auth.uid;
      allow list: if isSignedIn() && get(/databases/$(database)/documents/subscriptions/$(subscriptionId)).data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/subscriptions/$(subscriptionId)).data.userId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/subscriptions/$(subscriptionId)).data.userId == request.auth.uid;
    }
  }
}