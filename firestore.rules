/**
 * @fileoverview Firestore Security Rules for HealthSphere application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data
 * and separates doctor data for differentiated access control. It prioritizes
 * secure data access based on authenticated user identity. It assumes client
 * side validation is in place to validate user roles.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the authenticated user.
 * - /doctors/{doctorId}: Stores doctor profiles, accessible only to the authenticated doctor.
 * - /appointments/{appointmentId}: Stores appointment data, with access control based on patientId/doctorId.
 * - /transactions/{transactionId}: Stores transaction data related to appointments.
 * - /wallets/{walletId}: Stores wallet information for doctors.
 * - /reminders/{reminderId}: Stores reminders for users.
 * - /subscriptions/{subscriptionId}: Stores subscription information for users.
 *
 * Key Security Decisions:
 * - User listing is disallowed to prevent unauthorized access to user data.
 * - Write access to user and doctor profiles is restricted to the authenticated user/doctor.
 * - Assumes client side validation of `request.auth.token` to check user roles.
 *
 * Denormalization for Authorization:
 * The rules avoid `get()` calls by assuming that authorization data (e.g., doctorId, patientId)
 * is present within the documents being secured.
 *
 * Structural Segregation:
 * User and doctor data are stored in separate collections to apply different access control rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (get) Authenticated user can read their own profile.
     * @allow (create) Authenticated user can create their own profile if the userId matches their auth UID.
     * @allow (update) Authenticated user can update their own profile if the userId matches their auth UID.
     * @allow (delete) Authenticated user can delete their own profile if the userId matches their auth UID.
     * @deny (get) Unauthorized user attempts to read another user's profile.
     * @deny (create) Unauthorized user attempts to create a profile with a mismatched userId.
     * @deny (update) Unauthorized user attempts to update another user's profile.
     * @deny (delete) Unauthorized user attempts to delete another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to doctor profile information.
     * @path /databases/{database}/documents/doctors/{doctorId}
     * @allow (get) Authenticated doctor can read their own profile.
     * @allow (create) Authenticated doctor can create their own profile if the doctorId matches their auth UID.
     * @allow (update) Authenticated doctor can update their own profile if the doctorId matches their auth UID.
     * @allow (delete) Authenticated doctor can delete their own profile if the doctorId matches their auth UID.
     * @deny (get) Unauthorized user attempts to read another doctor's profile.
     * @deny (create) Unauthorized user attempts to create a profile with a mismatched doctorId.
     * @deny (update) Unauthorized user attempts to update another doctor's profile.
     * @deny (delete) Unauthorized user attempts to delete another doctor's profile.
     * @principle Enforces document ownership for doctor profiles.
     */
    match /doctors/{doctorId} {
      allow get: if isOwner(doctorId);
      allow list: if false;
      allow create: if isOwner(doctorId) && request.resource.data.id == doctorId;
      allow update: if isExistingOwner(doctorId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(doctorId);
    }

    /**
     * @description Controls access to appointment information.
     * @path /databases/{database}/documents/appointments/{appointmentId}
     * @allow (get) Any authenticated user can read appointment information.
     * @allow (create) Any authenticated user can create appointment information.
     * @allow (update) Any authenticated user can update appointment information.
     * @allow (delete) Any authenticated user can delete appointment information.
     * @deny (none) No specific denial conditions, write operations are open for prototyping only.
     * @principle Allows any authenticated user to perform CRUD operations on appointments.
     */
    match /appointments/{appointmentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to transaction information.
     * @path /databases/{database}/documents/transactions/{transactionId}
     * @allow (get) Any authenticated user can read transaction information.
     * @allow (create) Any authenticated user can create transaction information.
     * @allow (update) Any authenticated user can update transaction information.
     * @allow (delete) Any authenticated user can delete transaction information.
     * @deny (none) No specific denial conditions, write operations are open for prototyping only.
     * @principle Allows any authenticated user to perform CRUD operations on transactions.
     */
    match /transactions/{transactionId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to wallet information.
     * @path /databases/{database}/documents/wallets/{walletId}
     * @allow (get) Any authenticated user can read wallet information.
     * @allow (create) Any authenticated user can create wallet information.
     * @allow (update) Any authenticated user can update wallet information.
     * @allow (delete) Any authenticated user can delete wallet information.
     * @deny (none) No specific denial conditions, write operations are open for prototyping only.
     * @principle Allows any authenticated user to perform CRUD operations on wallets.
     */
    match /wallets/{walletId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to reminder information.
     * @path /databases/{database}/documents/reminders/{reminderId}
     * @allow (get) Any authenticated user can read reminder information.
     * @allow (create) Any authenticated user can create reminder information.
     * @allow (update) Any authenticated user can update reminder information.
     * @allow (delete) Any authenticated user can delete reminder information.
     * @deny (none) No specific denial conditions, write operations are open for prototyping only.
     * @principle Allows any authenticated user to perform CRUD operations on reminders.
     */
    match /reminders/{reminderId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to subscription information.
     * @path /databases/{database}/documents/subscriptions/{subscriptionId}
     * @allow (get) Any authenticated user can read subscription information.
     * @allow (create) Any authenticated user can create subscription information.
     * @allow (update) Any authenticated user can update subscription information.
     * @allow (delete) Any authenticated user can delete subscription information.
     * @deny (none) No specific denial conditions, write operations are open for prototyping only.
     * @principle Allows any authenticated user to perform CRUD operations on subscriptions.
     */
    match /subscriptions/{subscriptionId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}